# 엔티티 매핑

## 객체와 테이블 매핑

### 1. @Entity

- @Entity가 붙은 클래스는 JPA가 관리, 엔티티라 한다.
- JPA를 사용해서 테이블과 매핑할 클래스는 해당 어노테이션이 필수다. 

- 기본 생성자 필수
- final 클래스, enum, interface, inner 클래스 사용하면 안된다.
- 저장할 필드에 final 사용하면 안된다.

### @Entity 속성 저리

- name
  - JPA에서 사용할 엔티티 이름을 지정한다.
  - 기본값 : 클래스 이름
  - 같은 클래스 이름이 없다면 기본값을 사용한다.

### @Table

- 엔티티와 매핑할 테이블 지정

  | 속성                   | 기능                                | 기본값      |
  | ---------------------- | ----------------------------------- | ----------- |
  | name                   | 매핑할 테이블 이름                  | 엔티티 이름 |
  | catalog                | 데이터베이스 catalog 매핑           |             |
  | schema                 | 데이터베이스 schema 매핑            |             |
  | uniqueConstraints(DDL) | DDL 생성 시에 유니크 제약 조건 생성 |             |




## 필드와 컬럼 매핑

### 매핑 어노테이션 정리

| 어노테이션  | 설명                                         |
| ----------- | -------------------------------------------- |
| @Column     | 컬럼 매핑                                    |
| @Temporal   | 날짜 타입 매핑                               |
| @Enumerated | enum 타입 매핑                               |
| @Lob        | BLOB, CLOB 매핑                              |
| @Transient  | 특정 필드를 컬럼에 매핑하지 않음 (매핑 무시) |

### 1. @Column

| 속성                  | 설명                                                         | 기본값         |
| --------------------- | ------------------------------------------------------------ | -------------- |
| name                  | 필드와 매핑할 테이블의 컬럼 이름                             | 객체 필드 이름 |
| insertable, updatable | 등록, 변경 가능 여부                                         | TRUE           |
| nullable(DDL)         | null 값의 허용 여부를 설정한다. false로 설정하면 DDL 생성 시에 not null 제약조건이 붙는다. |                |
| unique(DDL)           | @Table의 uniqueConstraints와 같지만 한 컬럼에 간단히 유니크 제약조건을 걸 때 사용한다 |                |
| columnDefinition(DDL) | 데이터베이스 컬럼 정보를 직접 줄 수 있다                     |                |
| length(DDL)           | 문자 길이 제약족, String 타입에만 사용한다.                  |                |
| precision, scale(DDL) | BigDeciaml 타입에서 사용한다. precision은 소수점을 포함한 전체 자릿수를, scale은 소수의 자릿수다. |                |

### 2. @Enumerated

- 자바 enum 타입을 매핑할 때 사용

- ORDINAL은 사용하지 않는 것이 좋다.
  - 중간에 enum 값이 추가되거나 변경되면 문제가 생길 수 있다.

| 속성             | 설명                            |
| ---------------- | ------------------------------- |
| EnumType.ORDINAL | enum 순서를 데이터베이스에 저장 |
| EnumType.STRING  | enum 이름을 데이터베이스에 저장 |

### 3. @Temporal

- 날짜 타입을 매핑할 때 사용
- 참고 : LocalDate, LocalDateTime을 사용할 때는 생략 가능

| 속성                   | 설명                                            | 기본값 |
| ---------------------- | ----------------------------------------------- | ------ |
| TemporalType.DATE      | 날짜, 데이터베이스 date 타입과 매핑             |        |
| TemporalType.TIME      | 시간, 데이터베이스 time 타입과 매핑             |        |
| TemporalType.TIMESTAMP | 날짜와 시간, 데이터베이스 timestamp 타입과 매핑 |        |

### 4. @Lob

데이터베이스 BLOB, CLOB 타입으로 매핑

- @Lob에는 지정할 수 있는 속성이 없다.
- 매핑하는 필드 타입이 문자면 CLOB 매핑, 나머지는 BLOB 매핑

### 5. @Transient

- 필드 매핑을 하지 않는다.
- 데이터베이스제 저장 X, 조회 X
- 주로 메모리상에서만 임시로 어떤 값을 보관하고 싶을 때 사용한다.



## 기본 키 매핑

### 기본 키 매핑 방법

- 직접 할당 : @Id만 사용

- 자동 생성 (@GeneratedValue)

  - identity : 데이터베이스에 위임, mysql

  - sequence : 데이터베이스 시퀀스 오브젝트 사용, ORACLE

    - @SequenceGenerator 필요

  - table : 키 생성용 테이블 사용, 모든 데이터베이스에서 사용

    - @TableGenerator 필요

  - auto : 방언에 따라 자동 지정, 기본값

    

### IDENTITY 전략 - 특징

- 기본 키 생성을 데이터베이스에 위임
- 주로 mysql, postgresql, sql server, db2에서 사용한다.
- JPA는 보통 트랜잭션 커밋 시점에 insert 쿼리를 실행한다.
- auto_increment는 데이터베이스에 insert 쿼리를 실행한 이후에 id값을 알 수 있다.
- identity 전략은 em.persist() 시점에 즉시 insert 쿼리를 실행하고 db에서 식별자를 조회한다.

### SEQUENCE 전략 - 특징

- 데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 특별한 데이터베이스 오브젝트
- 오라클, postgresql, db2, h2 데이터베이스에서 사용

   ### SEQUENCE - @SequenceGenerator

| 속성           | 설명                                                         | 기본값             |
| -------------- | ------------------------------------------------------------ | ------------------ |
| name           | 식별자 생성기 이름                                           | 필수               |
| sequenceName   | 데이터베이스에 등록되어 있는 시퀀스 이름                     | hibernate_sequence |
| initialValue   | DDL 생성 시에만 사용된다. 시퀀스 DDL을 생성할 때 처음 1      | 1                  |
| allocationSize | 시퀀스 한 번 호출에 증가하는 수, 데이터베이스 시퀀스 값이 하나씩 증가하도록 설정되어 있으면 이 값을 반드시 1로 설정해야 한다. | 50                 |





### 테이블 전략

- 키 생성 전용 테이블을 하나 만들어서 데이터베이스 시퀀스를 흉내내는 전략
- 장점 : 모든 데이터베이스에 적용 가능
- 단점 : 성능이 떨어진다

### @TableGenerator - 주요 속성

| 속성           | 설명                                                  | 기본값              |
| -------------- | ----------------------------------------------------- | ------------------- |
| name           | 식별자 생성기 이름                                    | 필수                |
| table          | 키 생성 테이블명                                      | hibernate_sequences |
| allocationSize | 시퀀스 한 번 호출에 증가하는 수(성능 최적화에 사용됨) | 50                  |
|                |                                                       |                     |

### 권장하는 식별자 전략

- 기본 키 제약 조건 : null이면 안되고, 유일해야 하고, 변하면 안된다.
- 권장 : Long 형 + 대체키 + 키 생성전략 사용

