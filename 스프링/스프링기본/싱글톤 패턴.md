# 싱글톤

- 클래스의 인스턴스가 딱 1개만 생성되는 것을 보장하는 디자인패턴
- private 생성자를 사용해서 외부에서 new 키워드를 사용하지 못하도록 해야 한다.



**싱글톤 패턴 문제점**

- 싱글톤 패턴을 구현하는 코드량이 많이 들어간다.
- 의존관계상 클라이언트가 구체 클래스에 의존한다  ➨ DIP를 위반한다.
- 클라이언트가 구체 클래스에 의존해서 OCP 원칙을 위반할 수도 있다.
- 테스트하기 어렵다.
- 내부 속성을 변경하거나 초기화하기 어렵다.
- private 생성자때문에 자식 클래스를 만들기 어렵다



## 싱글톤 방식의 주의점

- 특정 클라이언트에 의존적인 필드가 있으면 안된다.
- 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다.
- 필드 대신에 자바에서 공유되지 않는 지역변수, 파라미터, ThreadLocal 등을 사용해야 한다.

   ➨ 무상태로 설계해야 한다.



## @Configuration과 싱글톤

![image](https://user-images.githubusercontent.com/40904001/191405635-09f47e13-8ad3-4b8e-b64e-b0ed9d54bddf.png)

Appconfig 코드를 보면 MemberService를 호출하거나 OrderService를 호출할 때 모두 new MemoryMemberRepository 코드가 실행이 되는 데, 이러면 싱글톤 패턴이 깨지는 것이 아닌가 하는 생각이 들수 있다.

**테스트 코드**

![image](https://user-images.githubusercontent.com/40904001/191405875-267c18bb-38f6-4b12-a60e-71acdb0e3666.png)

 ![image](https://user-images.githubusercontent.com/40904001/191406631-74057a6f-7bf6-4fbb-90b7-cb46cbae746d.png)

하지만 MemberService에서의 memberRepository와 OrderService에서 memberRepository는 동일한 객체고, 싱글톤 패턴이 유지된다. 

어떻게 이게 가능한 것일까?

## @Configuration과 바이트코드 조작

AppConfig 스프링 빈을 조회해서 클래스 정보를 출력하면 다음과 같은 결과가 나온다.

![image](https://user-images.githubusercontent.com/40904001/191407016-8d6323e9-91f0-4759-8db6-159e59e99a82.png)

이것이 의미하는 건 해당 클래스가 내가 만든 클래스가 아닌 스프링이 CGLIB라는 바이트코드 조작 라이브러리를 사용해서 AppConfig를 상속받은 임의의 다른 클래스를 만들고, 그 클래스를 스프링 빈으로 등록한 것이다.

그리고 해당 클래스가 싱글톤이 보장되도록 해준다.

**@Configuration이 없으면 AppConfig자체가 스프링빈에 등록되고 싱글톤이 깨지게 된다.**



## 궁금한 거

