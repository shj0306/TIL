# 로그스태시

## 로그스태시란?

- 플러그인 기반의 오픈소스 데이터 처리 파이프라인 도구
- 복잡하고 귀찮은 데이터 전처리 과정을 별도 애플리케이션 작성 없이 비교적 간단한 설정만으로 수행할 수 있다. (데이터를 저장하기 전 사용자가 원하는 형태로 변경할 수 있다.)
- 장애 대응 로직이나 성능 저하 요인을 쉽게 파악할 수 있는 모니터링 API 제공

![img](https://blog.kakaocdn.net/dn/tb2YH/btrJRES8WLZ/VvO9aq1FFM4fKsC2OsJGP0/img.png)

## 파이프라인

- 데이터를 입력받아 실시간으로 변경하고 이를 다른 시스템에 전달하는 역할을 하는 로그스태시의 핵심 기능
- 입력, 필터, 출력이라는 세가지 구성요소로 이루어짐.

![img](https://blog.kakaocdn.net/dn/b4Xvhr/btrJRxT2ZcF/JwG1G5bOznac0tJRMjajC0/img.png)



### 입력

파이프라인의 가장 앞부분에 위치하며 원본으로부터 데이터를 입력받는 단계

자주 사용하는 입력 플러그인

| 플러그인 | 설명                                                         |
| -------- | ------------------------------------------------------------ |
| file     | 리눅스의 tail -f 명령처럼 파일을 스트리밍하여 이벤트를 읽어 들인다 |
| syslog   | 네트워크를 통해 전달되는 syslog를 수신한다.                  |
| kafka    | 카프카 토픽에서 데이터를 읽어 들인다                         |
| jdbc     | jdbc 드라이버로 지정한 일정마다 쿼리를 실행해 결과를 읽어들인다. |

#### 예제1. 파일에서 읽어 들이기

```json
input {
  file {
    path => "/Users/user/elk/elasticsearch-7.16.2/logs/elasticsearch.log"
    start_position => "beginning"
  }
}

output {
  stdout { }
}
```

#### 예제2. 카프카에서 읽어 들이기

```json
input {
  kafka {
      bootstrap_servers => "127.0.0.1:9092"
      group_id => "logstash"
      topics => ["apache_logs"]
      consumer_threads => 1
      decorate_events => true
    }
}

output {
  stdout { }
}
```

### 필터

비정형 데이터를 정형화하고 데이터 분석을 위한 구조를 잡아준다. 필터 플러그인을 이용하여 데이터를 정형화 시킬 수 있다.

| 플러그인 | 설명                                                         |
| -------- | ------------------------------------------------------------ |
| grok     | grok 패턴을 사용해 메시지를 구조화된 형태로 분석             |
| dissect  | 간단한 패턴을 사용해 메시지를 구조화된 형태로 분석. grok에 비해 자유도는 떨어지지만 빠름 |
| mutate   | 필드명을 변경하거나 문자열 처리 등 일반적인 가공 함수들을 제공 |
| date     | 문자열을 지정한 패턴의 날짜형으로 분석                       |



### 출력

파이프라인의 입력과 필터를 거쳐 가공된 데이터를 지정한 대상으로 내보내는 단계

| 플러그인      | 설명                                               |
| ------------- | -------------------------------------------------- |
| elasticsearch | bulk api를 사용해 엘라스틱서치에 인덱싱을 수행한다 |
| file          | 지정한 파일의 새로운 줄에 데이터를 기록한다        |
| kafka         | 카프카 토픽에 데이터를 기록한다                    |

#### 예제.  file, elasticsearch을 이용해 출력하기

```json
input {
  file {
    path => "/Users/user/elk/elasticsearch-7.16.2/logs/elasticsearch.log"
    start_position => "beginning"
  }
}

output {
  file {
    path => "/Users/user/elk/elasticsearch-7.16.2/logs/output.log"
  }
  elasticseach {
    index => "output"
  }
}
```

### 참고 블로그

- [평범한개발자노트](https://cornswrold.tistory.com/568)

